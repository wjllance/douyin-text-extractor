# 抖音视频下载功能说明

## 功能概述

本项目的 `downloadVideo()` 方法已升级，支持以下新特性：

1. **配置化下载目录** - 通过配置文件指定下载目录
2. **按 VideoID 命名** - 使用抖音视频 ID 作为文件名
3. **智能跳过重复下载** - 自动检测已存在文件，避免重复下载

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# 视频下载目录
DOWNLOAD_DIR=./downloads

# 其他现有配置...
TEMP_DIR=./temp
MAX_FILE_SIZE=100MB
```

### 默认配置

如果未指定 `DOWNLOAD_DIR`，系统将使用默认值：`./downloads`

## 功能特性

### 1. 配置化下载目录

```typescript
// config/index.ts
export const config = {
  // 文件配置
  downloadDir:
    process.env.DOWNLOAD_DIR || path.join(process.cwd(), "downloads"),
  // ...
};
```

### 2. 按 VideoID 命名文件

- **旧方式**: 使用视频标题作为文件名（可能包含特殊字符）
- **新方式**: 使用 VideoID 作为文件名，格式为 `{videoId}.mp4`

```typescript
// 示例文件名
// 旧: "抖音视频标题包含特殊字符!@#.mp4"
// 新: "7372484719365098803.mp4"
```

### 3. 智能跳过重复下载

系统会在下载前检查文件是否已存在：

```typescript
// 检查逻辑
if (fs.existsSync(videoPath)) {
  progressCallback?.({
    stage: "downloading",
    progress: 100,
    message: `视频已存在，跳过下载: ${videoInfo.videoId}`,
  });
  return videoPath;
}
```

## 使用示例

### 基本用法

```typescript
import { DouyinService } from "./services/DouyinService";
import { config } from "./config";

const service = new DouyinService(
  config.speechApi.key,
  config.speechApi.baseUrl,
  config.speechApi.model
);

// 解析视频信息
const videoInfo = await service.parseShareUrl(shareLink);

// 下载视频（支持进度回调）
const videoPath = await service.downloadVideo(videoInfo, (progress) => {
  console.log(`${progress.stage}: ${progress.progress}% - ${progress.message}`);
});

console.log(`视频已保存到: ${videoPath}`);
```

### 完整流程示例

```typescript
async function downloadDouyin(shareLink: string) {
  const service = new DouyinService(apiKey, baseUrl, model);

  try {
    // 1. 解析链接
    const videoInfo = await service.parseShareUrl(shareLink);
    console.log(`VideoID: ${videoInfo.videoId}`);
    console.log(`标题: ${videoInfo.title}`);

    // 2. 下载视频
    const videoPath = await service.downloadVideo(videoInfo, (progress) => {
      console.log(`${progress.message}`);
    });

    // 3. 检查结果
    console.log(`下载完成: ${videoPath}`);
    return videoPath;
  } catch (error) {
    console.error(`下载失败: ${error.message}`);
  }
}
```

## 进度回调信息

下载过程中会触发以下进度回调：

```typescript
interface ProcessingProgress {
  stage: "downloading";
  progress: number; // 0-100
  message: string; // 详细状态信息
}
```

### 回调示例

1. **开始下载**

   ```
   stage: "downloading"
   progress: 0
   message: "开始下载视频: 视频标题 (7372484719365098803)"
   ```

2. **下载进度**

   ```
   stage: "downloading"
   progress: 45
   message: "下载进度: 45% (7372484719365098803)"
   ```

3. **下载完成**

   ```
   stage: "downloading"
   progress: 100
   message: "视频下载完成: 7372484719365098803"
   ```

4. **跳过下载**
   ```
   stage: "downloading"
   progress: 100
   message: "视频已存在，跳过下载: 7372484719365098803"
   ```

## 目录结构

```
project/
├── downloads/                 # 下载目录（可配置）
│   ├── 7372484719365098803.mp4
│   ├── 7373123456789012345.mp4
│   └── ...
├── temp/                      # 临时文件目录
└── src/
    ├── services/
    │   └── DouyinService.ts   # 核心服务
    └── config/
        └── index.ts           # 配置文件
```

## 测试脚本

使用提供的测试脚本验证功能：

```bash
# 编译代码
npm run build

# 运行测试
node test-download.js
```

测试脚本会：

1. 解析测试链接
2. 执行第一次下载
3. 执行第二次下载（验证跳过功能）
4. 显示下载目录中的所有文件

## 错误处理

系统会处理以下错误情况：

1. **下载失败** - 自动清理部分下载的文件
2. **目录权限** - 自动创建下载目录
3. **重复下载** - 智能跳过已存在文件
4. **网络错误** - 提供详细错误信息

## 注意事项

1. **文件覆盖**: 相同 VideoID 的文件不会被覆盖，会直接跳过下载
2. **目录权限**: 确保下载目录有写入权限
3. **磁盘空间**: 下载前请确保有足够的磁盘空间
4. **网络稳定**: 建议在稳定的网络环境下使用

## 升级说明

### 从旧版本升级

如果你从旧版本升级，需要：

1. 更新 `.env` 文件，添加 `DOWNLOAD_DIR` 配置
2. 重新编译代码：`npm run build`
3. 旧的临时文件可以手动清理

### 向后兼容性

- 所有现有的 API 接口保持不变
- 进度回调接口保持兼容
- 返回值类型不变（文件路径字符串）
