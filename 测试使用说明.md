# 🧪 抖音 API 测试使用说明

本项目提供了多种测试工具来验证抖音视频文本提取 API 的功能。

## 📁 测试文件说明

### 1. `test-script.js` - Node.js 测试脚本

- **功能**: 完整的 API 功能测试工具
- **特点**: 彩色输出、详细日志、性能测量
- **依赖**: Node.js, axios

### 2. `test.sh` - Bash 测试脚本

- **功能**: 使用 curl 的轻量级测试工具
- **特点**: 无需 Node.js 环境、JSON 格式化输出
- **依赖**: bash, curl, jq(可选)

### 3. `example-test.js` - 示例测试脚本

- **功能**: 演示如何使用测试工具的示例代码
- **特点**: 教学示例、多种测试场景

## 🚀 快速开始

### 启动服务

首先确保 API 服务正在运行：

```bash
# 开发模式启动
npm run dev

# 或者编译后启动
npm run build
npm start
```

### 基础测试（无需 API 密钥）

```bash
# 使用Node.js脚本测试（跳过文本提取）
node test-script.js "https://v.douyin.com/xxx" --skip-text

# 使用bash脚本测试
./test.sh "https://v.douyin.com/xxx" --skip-text
```

### 完整测试（需要 API 密钥）

```bash
# 设置环境变量
export SPEECH_API_KEY="your-siliconflow-api-key"

# 运行完整测试
node test-script.js "https://v.douyin.com/xxx"
./test.sh "https://v.douyin.com/xxx"
```

## 📋 测试功能覆盖

### 1. 服务健康检查

- **端点**: `GET /health`
- **验证**: 服务状态、版本信息
- **预期**: 200 状态码、正确的 JSON 响应

### 2. API 信息获取

- **端点**: `GET /api/info`
- **验证**: API 描述、可用端点列表
- **预期**: 完整的 API 文档信息

### 3. 链接解析测试

- **端点**: `POST /api/parse`
- **验证**: 抖音链接解析、视频信息提取
- **预期**: 视频 ID、标题、描述、下载链接

### 4. 下载链接获取

- **端点**: `POST /api/download-link`
- **验证**: 无水印下载链接生成
- **预期**: 可用的视频下载地址

### 5. 文本提取测试

- **端点**: `POST /api/extract-text`
- **验证**: 完整的视频转文本流程
- **预期**: 提取的文本内容、处理时间

## 🔧 测试脚本选项

### Node.js 脚本选项

```bash
node test-script.js <抖音链接> [选项]

选项:
  --skip-text     跳过文本提取测试
  --api-url URL   指定API服务地址
  --help          显示帮助信息
```

### Bash 脚本选项

```bash
./test.sh <抖音链接> [选项]

选项:
  --skip-text     跳过文本提取测试
  --api-url URL   指定API服务地址
  --help          显示帮助信息
```

## 🌍 环境变量配置

| 变量名           | 说明              | 默认值                  | 必需              |
| ---------------- | ----------------- | ----------------------- | ----------------- |
| `API_BASE_URL`   | API 服务地址      | `http://localhost:3000` | ❌                |
| `SPEECH_API_KEY` | 语音识别 API 密钥 | 无                      | ✅ (文本提取功能) |

## 📊 测试输出示例

### 成功的测试输出

```
🚀 开始抖音视频处理功能测试
==================================================

📋 步骤 1: 测试服务健康状态
✅ 服务状态: success
ℹ️  版本: 1.0.0

📋 步骤 2: 获取API信息
✅ API名称: Douyin Video Text Extraction API
ℹ️  描述: Node.js + TypeScript API for extracting text from Douyin videos

📋 步骤 3: 解析抖音链接
✅ 链接解析成功 (1205ms)
ℹ️  视频ID: 7234567890123456789
ℹ️  标题: 示例视频标题
ℹ️  下载链接: https://example.com/video.mp4...

📋 步骤 4: 获取下载链接
✅ 获取下载链接成功 (856ms)
ℹ️  使用提示: 可以直接使用此链接下载无水印视频

📋 步骤 5: 提取视频文本
ℹ️  开始文本提取流程，这可能需要一些时间...
✅ 文本提取成功 (15230ms)
ℹ️  提取的文本: "这是从视频中提取的文本内容"

📊 测试结果总结
==================================================
✅ 健康检查: 通过
✅ API信息: 通过
✅ 链接解析: 通过
✅ 下载链接: 通过
✅ 文本提取: 通过

🎯 测试完成: 5/5 项通过
```

## 🚨 常见错误与解决

### 1. 服务连接失败

**错误信息**:

```
❌ 无法连接到服务，请确保服务正在运行在 http://localhost:3000
```

**解决方法**:

- 确认 API 服务已启动: `npm run dev`
- 检查端口是否正确
- 确认防火墙设置

### 2. API 密钥未设置

**错误信息**:

```
❌ 未设置语音识别API密钥，请在环境变量中设置 SPEECH_API_KEY
```

**解决方法**:

```bash
export SPEECH_API_KEY="your-api-key"
# 或在 .env 文件中设置
echo "SPEECH_API_KEY=your-api-key" >> .env
```

### 3. 链接解析失败

**错误信息**:

```
❌ 解析抖音链接失败: 未找到有效的分享链接
```

**解决方法**:

- 确认使用的是有效的抖音分享链接
- 检查链接格式是否正确
- 尝试使用最新的分享链接

### 4. FFmpeg 相关错误

**错误信息**:

```
❌ 提取音频失败: Cannot find ffmpeg
```

**解决方法**:

```bash
# macOS
brew install ffmpeg

# Ubuntu/Debian
sudo apt install ffmpeg

# 确认安装
ffmpeg -version
```

## 🔄 持续集成测试

### GitHub Actions 示例

```yaml
name: API Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          npm install

      - name: Build project
        run: npm run build

      - name: Start API server
        run: npm start &

      - name: Wait for server
        run: sleep 10

      - name: Run basic tests
        run: node test-script.js "https://v.douyin.com/example" --skip-text
```

## 📈 性能基准测试

### 预期性能指标

| 操作     | 预期时间 | 备注           |
| -------- | -------- | -------------- |
| 健康检查 | < 100ms  | 本地响应       |
| API 信息 | < 100ms  | 静态数据       |
| 链接解析 | < 2s     | 网络请求       |
| 下载链接 | < 2s     | 网络请求       |
| 文本提取 | 10-60s   | 取决于视频长度 |

### 性能测试脚本

```bash
# 运行多次测试计算平均时间
for i in {1..5}; do
  echo "=== 测试轮次 $i ==="
  node test-script.js "https://v.douyin.com/xxx" --skip-text
done
```

## 🎯 测试最佳实践

### 1. 测试前准备

- 确保服务已启动且稳定运行
- 准备有效的抖音分享链接
- 设置必要的环境变量

### 2. 测试策略

- 先运行基础功能测试（不需要 API 密钥）
- 再运行完整功能测试（需要 API 密钥）
- 使用不同类型的视频链接进行测试

### 3. 错误处理

- 仔细阅读错误信息
- 检查日志文件获取详细信息
- 逐步排查问题根源

### 4. 性能优化

- 监控响应时间
- 关注内存使用情况
- 定期清理临时文件

---

💡 **提示**: 建议在开发过程中经常运行测试，确保功能正常。如果遇到问题，请查看详细的错误日志并参考故障排除指南。
