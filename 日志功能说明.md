# DouyinService 日志功能说明

## 概述

为了更好地监控和调试抖音视频处理流程，我们在 `DouyinService` 中集成了详细的日志记录功能。使用 Winston 日志库，提供结构化的日志输出，便于问题排查和性能监控。

## 日志级别

### 1. `info` - 关键信息

记录重要的业务流程和状态信息：

- 服务初始化
- 方法开始和完成
- 文件操作结果
- 性能指标

### 2. `debug` - 调试信息

记录详细的执行步骤：

- HTTP 请求详情
- 文件系统操作
- 进度更新
- 中间结果

### 3. `error` - 错误信息

记录所有错误和异常：

- 业务逻辑错误
- 网络请求失败
- 文件操作异常
- API 调用错误

## 详细日志内容

### 服务初始化

```json
{
  "level": "info",
  "message": "DouyinService initialized",
  "speechApiBaseUrl": "https://api.siliconflow.cn/v1/audio/transcriptions",
  "speechModel": "FunAudioLLM/SenseVoiceSmall",
  "hasApiKey": true,
  "timestamp": "2024-01-01 12:00:00"
}
```

### 链接解析流程

#### 开始解析

```json
{
  "level": "info",
  "message": "开始解析抖音分享链接",
  "shareText": "https://v.douyin.com/iFhbaXJa/",
  "timestamp": "2024-01-01 12:00:01"
}
```

#### 提取链接

```json
{
  "level": "info",
  "message": "提取到分享链接",
  "shareUrl": "https://v.douyin.com/iFhbaXJa/",
  "timestamp": "2024-01-01 12:00:01"
}
```

#### 获取视频 ID

```json
{
  "level": "info",
  "message": "提取到视频ID",
  "videoId": "7372484719365098803",
  "finalUrl": "https://www.iesdouyin.com/share/video/7372484719365098803",
  "timestamp": "2024-01-01 12:00:02"
}
```

#### 解析完成

```json
{
  "level": "info",
  "message": "视频信息解析完成",
  "videoId": "7372484719365098803",
  "title": "抖音视频标题",
  "downloadUrl": "https://...",
  "desc": "视频描述",
  "processingTime": "1250ms",
  "timestamp": "2024-01-01 12:00:03"
}
```

### 视频下载流程

#### 开始下载

```json
{
  "level": "info",
  "message": "开始下载视频",
  "videoId": "7372484719365098803",
  "title": "抖音视频标题",
  "downloadUrl": "https://...",
  "downloadDir": "/path/to/downloads",
  "timestamp": "2024-01-01 12:00:03"
}
```

#### 文件已存在

```json
{
  "level": "info",
  "message": "文件已存在，跳过下载",
  "videoId": "7372484719365098803",
  "filePath": "/path/to/downloads/7372484719365098803.mp4",
  "fileSize": "25.6MB",
  "modifiedTime": "2024-01-01T12:00:00.000Z",
  "timestamp": "2024-01-01 12:00:03"
}
```

#### 开始流式下载

```json
{
  "level": "info",
  "message": "开始流式下载",
  "videoId": "7372484719365098803",
  "totalSize": "25.6MB",
  "status": 200,
  "headers": {
    "contentType": "video/mp4",
    "contentLength": "26843545"
  },
  "timestamp": "2024-01-01 12:00:04"
}
```

#### 下载进度

```json
{
  "level": "debug",
  "message": "下载进度更新",
  "videoId": "7372484719365098803",
  "progress": "50%",
  "downloaded": "12.8MB",
  "total": "25.6MB",
  "timestamp": "2024-01-01 12:00:10"
}
```

#### 下载完成

```json
{
  "level": "info",
  "message": "视频下载完成",
  "videoId": "7372484719365098803",
  "filePath": "/path/to/downloads/7372484719365098803.mp4",
  "fileSize": "25.6MB",
  "processingTime": "15750ms",
  "downloadSpeed": "1.62MB/s",
  "timestamp": "2024-01-01 12:00:18"
}
```

### 音频提取流程

#### 开始提取

```json
{
  "level": "info",
  "message": "开始提取音频",
  "videoPath": "/path/to/downloads/7372484719365098803.mp4",
  "audioPath": "/path/to/downloads/7372484719365098803.mp3",
  "videoExists": true,
  "timestamp": "2024-01-01 12:00:18"
}
```

#### FFmpeg 命令执行

```json
{
  "level": "debug",
  "message": "FFmpeg 命令开始执行",
  "commandLine": "ffmpeg -i input.mp4 -acodec libmp3lame -aq 0 output.mp3",
  "videoPath": "/path/to/downloads/7372484719365098803.mp4",
  "audioPath": "/path/to/downloads/7372484719365098803.mp3",
  "timestamp": "2024-01-01 12:00:19"
}
```

#### 提取完成

```json
{
  "level": "info",
  "message": "音频提取完成",
  "videoPath": "/path/to/downloads/7372484719365098803.mp4",
  "audioPath": "/path/to/downloads/7372484719365098803.mp3",
  "audioSize": "3.2MB",
  "processingTime": "4500ms",
  "timestamp": "2024-01-01 12:00:23"
}
```

### 语音识别流程

#### 开始识别

```json
{
  "level": "info",
  "message": "开始语音识别",
  "audioPath": "/path/to/downloads/7372484719365098803.mp3",
  "audioExists": true,
  "speechApiBaseUrl": "https://api.siliconflow.cn/v1/audio/transcriptions",
  "speechModel": "FunAudioLLM/SenseVoiceSmall",
  "timestamp": "2024-01-01 12:00:23"
}
```

#### API 请求准备

```json
{
  "level": "debug",
  "message": "准备API请求",
  "apiUrl": "https://api.siliconflow.cn/v1/audio/transcriptions",
  "model": "FunAudioLLM/SenseVoiceSmall",
  "fileSize": "3.2MB",
  "timestamp": "2024-01-01 12:00:24"
}
```

#### 识别完成

```json
{
  "level": "info",
  "message": "语音识别完成",
  "audioPath": "/path/to/downloads/7372484719365098803.mp3",
  "textLength": 156,
  "processingTime": "8750ms",
  "apiStatus": 200,
  "hasText": true,
  "timestamp": "2024-01-01 12:00:32"
}
```

#### 识别结果预览

```json
{
  "level": "debug",
  "message": "识别结果预览",
  "textPreview": "这是一个很有趣的抖音视频，主要讲述了...",
  "fullTextLength": 156,
  "timestamp": "2024-01-01 12:00:32"
}
```

### 完整流程日志

#### 流程开始

```json
{
  "level": "info",
  "message": "开始完整文本提取流程",
  "shareLink": "https://v.douyin.com/iFhbaXJa/",
  "timestamp": "2024-01-01 12:00:01"
}
```

#### 步骤日志

```json
{
  "level": "debug",
  "message": "步骤1: 解析链接",
  "timestamp": "2024-01-01 12:00:01"
}
```

#### 流程完成

```json
{
  "level": "info",
  "message": "文本提取流程完成",
  "videoId": "7372484719365098803",
  "textLength": 156,
  "totalProcessingTime": "31250ms",
  "tempFilesProcessed": 2,
  "timestamp": "2024-01-01 12:00:32"
}
```

## 错误日志示例

### 链接解析错误

```json
{
  "level": "error",
  "message": "解析抖音链接失败",
  "shareUrl": "https://v.douyin.com/invalid/",
  "error": "HTTP 404 Not Found",
  "processingTime": "2150ms",
  "stack": "Error: HTTP 404...",
  "timestamp": "2024-01-01 12:00:03"
}
```

### 下载错误

```json
{
  "level": "error",
  "message": "视频下载失败",
  "videoId": "7372484719365098803",
  "filePath": "/path/to/downloads/7372484719365098803.mp4",
  "error": "ENOSPC: no space left on device",
  "processingTime": "5000ms",
  "stack": "Error: ENOSPC...",
  "timestamp": "2024-01-01 12:00:08"
}
```

### 语音识别错误

```json
{
  "level": "error",
  "message": "语音识别失败",
  "audioPath": "/path/to/downloads/7372484719365098803.mp3",
  "error": "API rate limit exceeded",
  "processingTime": "1000ms",
  "apiUrl": "https://api.siliconflow.cn/v1/audio/transcriptions",
  "stack": "Error: API rate limit...",
  "timestamp": "2024-01-01 12:00:25"
}
```

## 日志配置

### 环境变量

```bash
# 日志级别控制
LOG_LEVEL=info          # 生产环境推荐
LOG_LEVEL=debug         # 开发环境推荐

# 日志文件路径
LOG_FILE=./logs/app.log
```

### 日志文件

- **error.log**: 只记录错误级别的日志
- **combined.log**: 记录所有级别的日志
- **控制台输出**: 开发环境下同时输出到控制台

## 性能监控

### 关键指标

1. **链接解析时间**: 通常 1-3 秒
2. **视频下载时间**: 取决于文件大小和网络速度
3. **音频提取时间**: 通常是视频时长的 0.1-0.5 倍
4. **语音识别时间**: 取决于音频长度和 API 响应时间
5. **总处理时间**: 完整流程的总耗时

### 下载速度计算

```typescript
downloadSpeed = fileSize / (processingTime / 1000) / (1024 * 1024); // MB/s
```

## 故障排查

### 常见问题定位

1. **链接解析失败**

   - 检查分享链接格式
   - 查看网络连接状态
   - 确认抖音页面结构变化

2. **下载速度慢**

   - 检查网络带宽
   - 查看服务器负载
   - 确认下载源响应时间

3. **音频提取失败**

   - 确认 FFmpeg 安装状态
   - 检查视频文件完整性
   - 查看磁盘空间

4. **语音识别失败**
   - 验证 API 密钥有效性
   - 检查 API 配额使用情况
   - 确认音频文件格式

### 日志查询示例

```bash
# 查看特定视频的处理日志
grep "7372484719365098803" logs/combined.log

# 查看错误日志
grep "level.*error" logs/combined.log

# 查看性能较慢的请求
grep "processingTime.*[5-9][0-9][0-9][0-9]ms" logs/combined.log

# 查看下载进度
grep "下载进度" logs/combined.log
```

## 最佳实践

### 1. 生产环境配置

```bash
LOG_LEVEL=info
NODE_ENV=production
```

### 2. 开发环境配置

```bash
LOG_LEVEL=debug
NODE_ENV=development
```

### 3. 日志文件管理

- 定期清理过期日志文件
- 设置日志文件大小限制
- 使用日志轮转机制

### 4. 监控告警

- 设置错误率阈值告警
- 监控平均处理时间
- 跟踪磁盘空间使用情况

## 日志分析工具

### 推荐工具

1. **ELK Stack** (Elasticsearch, Logstash, Kibana)
2. **Grafana + Loki**
3. **Fluentd + Prometheus**
4. **简单脚本分析**

### 自定义分析脚本示例

```bash
#!/bin/bash
# 分析今天的处理统计
TODAY=$(date +%Y-%m-%d)
LOG_FILE="logs/combined.log"

echo "=== $TODAY 处理统计 ==="
echo "总处理次数: $(grep "$TODAY.*文本提取流程完成" $LOG_FILE | wc -l)"
echo "成功次数: $(grep "$TODAY.*文本提取流程完成" $LOG_FILE | wc -l)"
echo "失败次数: $(grep "$TODAY.*文本提取流程失败" $LOG_FILE | wc -l)"
echo "平均处理时间: $(grep "$TODAY.*totalProcessingTime" $LOG_FILE | sed 's/.*totalProcessingTime":"//;s/ms.*//' | awk '{sum+=$1; count++} END {if(count>0) print sum/count "ms"}')"
```

通过这些详细的日志信息，您可以：

- 实时监控服务状态
- 快速定位问题原因
- 分析性能瓶颈
- 优化处理流程
- 提供运维支持
