# 🛠️ 抖音视频处理命令行工具使用说明

本项目提供了一套完整的命令行工具，可以在不启动 HTTP 服务器的情况下，直接通过命令行处理抖音视频。

## 📋 工具概览

| 工具名称             | 功能描述     | 主要用途             |
| -------------------- | ------------ | -------------------- |
| `douyin.js`          | 主要工具入口 | 统一的命令行界面     |
| `douyin-to-text.js`  | 视频转文本   | 提取视频中的语音文本 |
| `douyin-download.js` | 视频下载     | 下载无水印视频       |
| `douyin-batch.js`    | 批量处理     | 批量下载或转文本     |

## 🚀 快速开始

### 1. 环境准备

```bash
# 确保已安装依赖
npm install

# 编译TypeScript代码
npm run build

# 设置API密钥（文本提取功能需要）
export SPEECH_API_KEY="your-siliconflow-api-key"

# 检查环境状态
node scripts/douyin.js status
```

### 2. 基本使用

```bash
# 查看主要帮助
node scripts/douyin.js

# 下载视频
node scripts/douyin.js download "https://v.douyin.com/xxx"

# 提取文本
node scripts/douyin.js to-text "https://v.douyin.com/xxx"

# 批量处理
node scripts/douyin.js batch example-links.txt
```

## 📝 详细功能说明

### 1. 主工具 (douyin.js)

统一的命令行入口，提供环境检查和子命令调用。

```bash
# 基本语法
node scripts/douyin.js <命令> [参数]

# 可用命令
to-text     # 视频转文本
download    # 视频下载
batch       # 批量处理
help        # 帮助信息
status      # 环境检查
```

**示例**:

```bash
# 检查环境状态
node scripts/douyin.js status

# 获取命令帮助
node scripts/douyin.js help download
```

### 2. 视频转文本工具 (douyin-to-text.js)

将抖音视频中的语音转换为文本。

```bash
# 基本语法
node scripts/douyin-to-text.js <抖音链接> [选项]

# 选项
-o, --output <文件>    保存结果到文件 (.txt 或 .json)
-h, --help            显示帮助信息
```

**示例**:

```bash
# 基础转文本
node scripts/douyin-to-text.js "https://v.douyin.com/xxx"

# 保存为文本文件
node scripts/douyin-to-text.js "https://v.douyin.com/xxx" -o result.txt

# 保存为JSON文件
node scripts/douyin-to-text.js "https://v.douyin.com/xxx" -o result.json
```

**输出格式**:

- 控制台：彩色进度显示 + 最终文本结果
- 文本文件：包含视频信息和提取的文本
- JSON 文件：结构化数据，包含完整信息

### 3. 视频下载工具 (douyin-download.js)

下载抖音无水印视频。

```bash
# 基本语法
node scripts/douyin-download.js <抖音链接> [选项]

# 选项
-o, --output <路径>    指定输出文件或目录
-l, --link-only       仅获取下载链接，不实际下载
-h, --help           显示帮助信息
```

**示例**:

```bash
# 下载到当前目录
node scripts/douyin-download.js "https://v.douyin.com/xxx"

# 指定文件名
node scripts/douyin-download.js "https://v.douyin.com/xxx" -o "my_video.mp4"

# 指定目录
node scripts/douyin-download.js "https://v.douyin.com/xxx" -o "./downloads/"

# 仅获取下载链接
node scripts/douyin-download.js "https://v.douyin.com/xxx" --link-only
```

### 4. 批量处理工具 (douyin-batch.js)

批量处理多个抖音视频。

```bash
# 基本语法
node scripts/douyin-batch.js <链接文件> [选项]

# 选项
-m, --mode <模式>     处理模式: download, text, both (默认: both)
-o, --output <目录>   指定输出目录
-d, --delay <毫秒>    请求间隔延迟 (默认: 2000ms)
-h, --help           显示帮助信息
```

**处理模式**:

- `download`: 仅下载视频
- `text`: 仅提取文本（需要 API 密钥）
- `both`: 下载视频并提取文本

**链接文件格式**:

```
# 这是注释行
https://v.douyin.com/video1
https://v.douyin.com/video2
https://v.douyin.com/video3
```

**示例**:

```bash
# 批量下载
node scripts/douyin-batch.js links.txt -m download -o ./downloads

# 批量提取文本
node scripts/douyin-batch.js links.txt -m text

# 完整批量处理
node scripts/douyin-batch.js links.txt -m both -o ./output

# 设置请求延迟
node scripts/douyin-batch.js links.txt -d 3000
```

## 🎯 使用场景与最佳实践

### 场景 1: 单个视频处理

```bash
# 快速下载一个视频
node scripts/douyin.js download "https://v.douyin.com/xxx"

# 提取视频文本并保存
node scripts/douyin.js to-text "https://v.douyin.com/xxx" -o transcription.txt
```

### 场景 2: 批量内容分析

```bash
# 1. 准备链接文件
echo "https://v.douyin.com/video1" > analysis_list.txt
echo "https://v.douyin.com/video2" >> analysis_list.txt

# 2. 批量提取文本
node scripts/douyin.js batch analysis_list.txt -m text -o ./analysis_results

# 3. 查看生成的摘要
cat analysis_results/text_summary.txt
```

### 场景 3: 内容备份

```bash
# 批量下载并提取文本，完整备份
node scripts/douyin.js batch backup_list.txt -m both -o ./backup_$(date +%Y%m%d)
```

## 📊 输出文件说明

### 单个处理输出

**文本文件 (.txt)**:

```
视频标题: 示例视频标题
视频ID: 7234567890123456789
描述: 视频描述信息
提取时间: 2024-01-01T12:00:00.000Z

提取的文本内容:
这里是从视频中提取的文本内容...
```

**JSON 文件 (.json)**:

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "videoInfo": {
    "videoId": "7234567890123456789",
    "title": "示例视频标题",
    "downloadUrl": "https://...",
    "desc": "视频描述"
  },
  "extractedText": "提取的文本内容..."
}
```

### 批量处理输出

**处理报告 (batch_report.json)**:

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "summary": {
    "total": 10,
    "success": 8,
    "failure": 2,
    "duration": 300
  },
  "results": [...]
}
```

**文本摘要 (text_summary.txt)**:

```
抖音视频文本提取摘要
生成时间: 2024-01-01 12:00:00

1. 视频标题1
   视频ID: 7234567890123456789
   提取文本: 文本内容1...

2. 视频标题2
   视频ID: 7234567890123456790
   提取文本: 文本内容2...
```

## ⚙️ 环境变量配置

| 变量名                | 说明              | 必需         | 默认值               |
| --------------------- | ----------------- | ------------ | -------------------- |
| `SPEECH_API_KEY`      | 语音识别 API 密钥 | 文本提取必需 | 无                   |
| `SPEECH_API_BASE_URL` | API 服务地址      | 否           | SiliconFlow 默认地址 |
| `SPEECH_MODEL`        | 语音识别模型      | 否           | SenseVoiceSmall      |
| `TEMP_DIR`            | 临时文件目录      | 否           | ./temp               |
| `LOG_LEVEL`           | 日志级别          | 否           | info                 |

**设置方式**:

```bash
# 临时设置
export SPEECH_API_KEY="your-api-key"

# 永久设置 (添加到 .bashrc 或 .zshrc)
echo 'export SPEECH_API_KEY="your-api-key"' >> ~/.bashrc

# 使用 .env 文件
echo "SPEECH_API_KEY=your-api-key" >> .env
```

## 🚨 常见问题与解决

### 1. 项目未编译错误

```bash
❌ 项目未编译，请先运行: npm run build
```

**解决**:

```bash
npm run build
```

### 2. API 密钥未设置

```bash
❌ SPEECH_API_KEY 环境变量未设置
```

**解决**:

```bash
export SPEECH_API_KEY="your-siliconflow-api-key"
```

### 3. FFmpeg 未安装

```bash
❌ FFmpeg: 未安装
```

**解决**:

```bash
# macOS
brew install ffmpeg

# Ubuntu/Debian
sudo apt install ffmpeg

# Windows
# 下载并安装 FFmpeg，添加到PATH
```

### 4. 网络连接问题

```bash
❌ 解析抖音链接失败: 网络请求超时
```

**解决**:

- 检查网络连接
- 使用科学上网工具
- 重试操作

### 5. 链接格式错误

```bash
❌ 请提供有效的抖音分享链接
```

**解决**:

- 确保链接包含 `douyin.com`
- 使用最新的分享链接
- 检查链接是否完整

## 📈 性能优化建议

### 1. 批量处理优化

```bash
# 适当设置延迟，避免请求过于频繁
node scripts/douyin-batch.js links.txt -d 3000

# 先测试小批量，再处理大量数据
head -5 links.txt > test_links.txt
node scripts/douyin-batch.js test_links.txt
```

### 2. 存储空间管理

```bash
# 定期清理临时文件
rm -rf temp/*

# 使用专门的输出目录
mkdir -p downloads/$(date +%Y%m%d)
node scripts/douyin-batch.js links.txt -o downloads/$(date +%Y%m%d)
```

### 3. 并发处理

批量工具目前是串行处理，如需并发处理大量视频，可以：

```bash
# 分割链接文件
split -l 10 large_links.txt batch_

# 并行处理多个文件
for file in batch_*; do
  node scripts/douyin-batch.js "$file" -o "output_$file" &
done
wait
```

## 🔗 高级用法

### 1. 结合其他工具

```bash
# 与 jq 结合处理JSON结果
node scripts/douyin-to-text.js "URL" -o result.json
cat result.json | jq '.extractedText'

# 与 grep 搜索文本内容
node scripts/douyin-batch.js links.txt -m text
grep -r "关键词" ./text_summary.txt
```

### 2. 自动化脚本

```bash
#!/bin/bash
# daily_douyin_backup.sh

DATE=$(date +%Y%m%d)
OUTPUT_DIR="./backup_$DATE"

# 批量处理并备份
node scripts/douyin-batch.js daily_links.txt -m both -o "$OUTPUT_DIR"

# 压缩备份
tar -czf "douyin_backup_$DATE.tar.gz" "$OUTPUT_DIR"

echo "备份完成: douyin_backup_$DATE.tar.gz"
```

### 3. 监控和日志

```bash
# 重定向输出到日志文件
node scripts/douyin-batch.js links.txt 2>&1 | tee process.log

# 只保存错误信息
node scripts/douyin-batch.js links.txt 2> errors.log
```

---

💡 **提示**: 这些命令行工具提供了灵活且强大的抖音视频处理能力，无需启动 HTTP 服务器即可使用。建议根据具体需求选择合适的工具和参数。
